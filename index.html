<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!-- Native App Meta Tags -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Kidsy">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="https://placehold.co/180x180/8e44ad/ffffff?text=Kidsy">

<title>Kidsy</title>
<!-- Libs: Tone (Audio), Lucide (Icons), Confetti (Fun!) -->
<script src="https://cdn.jsdelivr.net/npm/tone@14.8.39/build/Tone.js"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

:root {
  /* Default Theme Variables - Vibrant & Colorful v2 */
  --bg-gradient: linear-gradient(135deg, #a6c0fe 0%, #f68084 100%); /* Light Blue/Coral */
  --text-primary: #3d336b; /* Dark Purple Text */
  --card-bg: rgba(255, 255, 255, 0.98);
  --accent-primary: #8e44ad; /* Purple */
  --accent-secondary: #f39c12; /* Orange */
  --accent-success: #2ecc71; /* Green */
  --accent-danger: #e74c3c; /* Red */
  --shadow-color: rgba(142, 68, 173, 0.18);
  --border-color: rgba(142, 68, 173, 0.09);
  --glow-color: rgba(243, 156, 18, 0.5);

  /* Use clamp for responsive font sizes */
  --word-font-size: clamp(3em, 12vw, 5em);
  --base-font-size: 17px;
}

/* --- Theme Definitions --- */
body.theme-ocean {
  --bg-gradient: linear-gradient(135deg, #48c6ef 0%, #6f86d6 100%);
  --text-primary: #00394f;
  --accent-primary: #36d1dc;
  --accent-secondary: #5b86e5;
  --shadow-color: rgba(54, 209, 220, 0.2);
  --border-color: rgba(54, 209, 220, 0.1);
  --glow-color: rgba(91, 134, 229, 0.6);
}

body.theme-sunset {
  --bg-gradient: linear-gradient(135deg, #fe8c00 0%, #f83600 100%);
  --text-primary: #611e00;
  --accent-primary: #fc4a1a;
  --accent-secondary: #f7b733;
  --shadow-color: rgba(252, 74, 26, 0.2);
  --border-color: rgba(252, 74, 26, 0.1);
  --glow-color: rgba(247, 183, 51, 0.6);
}

body.theme-forest {
  --bg-gradient: linear-gradient(135deg, #9ef5a5 0%, #5bb964 100%);
  --text-primary: #1b5e20;
  --accent-primary: #76b852;
  --accent-secondary: #f7b733;
  --shadow-color: rgba(118, 184, 82, 0.2);
  --border-color: rgba(118, 184, 82, 0.1);
  --glow-color: rgba(247, 183, 51, 0.6);
}

body.theme-pink {
  --bg-gradient: linear-gradient(135deg, #f43b47 0%, #453a94 100%);
  --text-primary: #f8f8f8;
  --card-bg: rgba(69, 58, 148, 0.85); /* Darker card for this theme */
  --accent-primary: #ff7eb9;
  --accent-secondary: #fed95f;
  --shadow-color: rgba(244, 59, 71, 0.2);
  --border-color: rgba(244, 59, 71, 0.1);
  --glow-color: rgba(254, 217, 95, 0.6);
}
body.theme-purple {
  --bg-gradient: linear-gradient(135deg, #9face6 0%, #74ebd5 100%);
  --text-primary: #4a148c;
  --accent-primary: #b06ab3;
  --accent-secondary: #4568dc;
  --shadow-color: rgba(176, 106, 179, 0.2);
  --border-color: rgba(176, 106, 179, 0.1);
  --glow-color: rgba(69, 104, 220, 0.6);
}
body.theme-skyblue {
    --bg-gradient: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%);
    --text-primary: #0d47a1;
    --accent-primary: #64b5f6;
    --accent-secondary: #ffb74d;
    --shadow-color: rgba(100, 181, 246, 0.2);
    --border-color: rgba(100, 181, 246, 0.1);
    --glow-color: rgba(255, 183, 77, 0.6);
}

/* --- Dark Mode Overrides --- */
body.dark {
  --text-primary: #e0e0e0;
  --card-bg: rgba(44, 62, 80, 0.97);
  --border-color: rgba(255, 255, 255, 0.08);
  --shadow-color: rgba(0,0,0,0.5);
  --glow-color: var(--accent-secondary);
}
body.dark.theme-default {
  --bg-gradient: linear-gradient(135deg, #1f4037 0%, #99f2c8 100%);
  --accent-primary: #6ab0de;
  --accent-secondary: #c39bd3;
}
body.dark.theme-ocean {
  --bg-gradient: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
  --accent-primary: #64c8bc;
  --accent-secondary: #4dd0e1;
}
body.dark.theme-sunset {
  --bg-gradient: linear-gradient(135deg, #cb2d3e 0%, #ef473a 100%);
  --accent-primary: #ffa88c;
  --accent-secondary: #ffc9ba;
}
body.dark.theme-forest {
  --bg-gradient: linear-gradient(135deg, #134e5e 0%, #71b280 100%);
  --accent-primary: #a5d6a7;
  --accent-secondary: #c8e6c9;
}
body.dark.theme-pink {
  --bg-gradient: linear-gradient(135deg, #cc2b5e 0%, #753a88 100%);
  --text-primary: #f8f8f8; /* Keep light text */
  --card-bg: rgba(117, 58, 136, 0.9); /* Darker card */
  --accent-primary: #f48fb1;
  --accent-secondary: #f8bbd0;
}
body.dark.theme-purple {
  --bg-gradient: linear-gradient(135deg, #4776e6 0%, #8e54e9 100%);
  --accent-primary: #b39ddb;
  --accent-secondary: #e6ceff;
}
body.dark.theme-skyblue {
    --bg-gradient: linear-gradient(135deg, #1fa2ff 0%, #12d8fa 50%, #a6ffcb 100%);
    --accent-primary: #6ec6ff;
    --accent-secondary: #b3e5fc;
}

/* --- Base Layout --- */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html, body {
  height: 100%;
  overflow: hidden;
  overscroll-behavior: none;
  font-size: var(--base-font-size);
}

body {
  font-family: 'Poppins', sans-serif;
  text-align: center;
  background: var(--bg-gradient);
  color: var(--text-primary);
  transition: background 0.3s ease, color 0.3s ease;
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  padding: 10px 0 0 0;
}

.main-wrapper {
  max-width: 700px;
  width: 100%;
  padding: 0 10px;
  display: flex;
  flex-direction: column; /* Tabs on top */
  flex-grow: 1;
  overflow: hidden;
  min-height: 0;
}

/* --- Tab Navigation --- */
.nav-tabs-container {
  display: flex;
  justify-content: center;
  align-items: center;
  margin-bottom: 15px;
  position: relative;
  flex-shrink: 0;
  width: 100%;
}

.nav-tabs {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  background: var(--card-bg);
  border-radius: 22px;
  padding: 8px;
  box-shadow: 0 6px 25px var(--shadow-color);
  border: 1px solid var(--border-color);
  position: relative;
  z-index: 2;
}

.nav-tab {
  padding: 10px 18px;
  margin: 5px;
  border: none;
  border-radius: 18px;
  cursor: pointer;
  font-size: 1.0rem;
  font-weight: 600;
  transition: all 0.2s ease;
  background: rgba(0, 0, 0, 0.05);
  color: var(--text-primary);
}

body.dark .nav-tab {
  background: rgba(255, 255, 255, 0.08);
}

.nav-tab:hover {
  background: rgba(0, 0, 0, 0.1);
  transform: translateY(-2px);
}
body.dark .nav-tab:hover {
  background: rgba(255, 255, 255, 0.15);
}

.nav-tab.active {
  background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
  color: white;
  box-shadow: 0 5px 18px hsla(from var(--accent-primary) h s l / 0.35);
  transform: translateY(-2px) scale(1.02);
}

/* --- SINGLE Game Section --- */
/* This is now the ONLY section, dynamically updated */
.grade-section {
  display: flex;
  flex-grow: 1;
  flex-direction: column;
  overflow: hidden;
  min-height: 0;
  animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
  from { opacity: 0; transform: translateY(15px) scale(0.98); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}

.container {
  padding: 25px;
  background: var(--card-bg);
  border-radius: 28px;
  box-shadow: 0 12px 45px var(--shadow-color);
  transition: all 0.2s ease;
  backdrop-filter: blur(12px);
  position: relative;
  z-index: 1;
  border: 1px solid var(--border-color);
  margin-bottom: 15px;
  flex-shrink: 1;
  /* This makes the container scrollable, not the whole page */
  overflow-y: auto;
  overscroll-behavior: contain;
  min-height: 0;
}

/* --- Game UI Elements --- */
.challenge-header {
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 20px;
}
.challenge-header .icon-btn {
  position: absolute;
  left: 0;
  width: 38px;
  height: 38px;
}
.challenge-header h1 {
  font-size: clamp(1.8rem, 7vw, 2.1rem);
  font-weight: 700;
  margin: 0;
  padding: 0 50px;
  background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: fadeIn 0.4s ease-out;
  text-shadow: 0 0 15px hsla(from var(--accent-primary) h s l / 0.1);
  letter-spacing: -0.5px;
}

@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}

/* --- Centering All Game Content --- */
/* This ensures content is stacked and centered */
#start-btn,
#word-display,
#settings-section,
#speak-controls,
#stats-grid,
#score-display,
#keyboard-hint,
#progress-bar,
#high-score-display,
#star-rating-display,
#countdown-overlay {
  display: block;
  width: fit-content;
  max-width: 100%;
  margin-left: auto;
  margin-right: auto;
  margin-bottom: 15px;
}
#word-display { width: 100%; }
#settings-section {
  width: 100%;
  max-width: 320px;
  padding: 12px;
}
#speak-controls { width: fit-content; }
#stats-grid { width: 100%; max-width: 400px; display: grid !important; }
#progress-bar { width: 100%; max-width: 400px; }
#high-score-display {
  font-weight: 600;
  font-size: 1rem;
  color: var(--text-primary);
  opacity: 0.8;
}

label {
  font-weight: 600;
  font-size: 1.0rem;
  display: block;
  margin-bottom: 10px;
  color: var(--text-primary);
  opacity: 0.9;
}

.timer-input {
  width: 110px;
  padding: 10px;
  border: 1px solid var(--border-color);
  border-radius: 12px;
  font-size: 1.0rem;
  font-weight: 600;
  text-align: center;
  transition: all 0.3s ease;
  font-family: 'Poppins', sans-serif;
  background: var(--card-bg);
  color: var(--text-primary);
  display: inline-block;
}

.timer-input:focus {
  outline: none;
  border-color: var(--accent-primary);
  box-shadow: 0 0 0 3px hsla(from var(--accent-primary) h s l / 0.2);
  transform: scale(1.03);
}

button {
  padding: 12px 22px;
  margin: 6px;
  border: none;
  border-radius: 14px;
  cursor: pointer;
  font-size: 1.0rem;
  font-weight: 600;
  font-family: 'Poppins', sans-serif;
  transition: all 0.15s ease;
  box-shadow: 0 4px 12px var(--shadow-color);
  position: relative;
  overflow: hidden;
  background-color: rgba(0, 0, 0, 0.05);
  color: var(--text-primary);
}
body.dark button {
    background-color: rgba(255, 255, 255, 0.1);
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

button:hover {
  transform: translateY(-2px) scale(1.02);
  box-shadow: 0 6px 18px hsla(from var(--shadow-color) h s l / 1.5);
}

button:active {
  transform: translateY(0) scale(0.97); /* Squish effect */
  box-shadow: 0 2px 8px var(--shadow-color);
}

#start-btn {
  background: linear-gradient(135deg, var(--accent-success), #27ae60);
  color: white;
  font-size: 1.1rem;
  padding: 14px 32px;
  box-shadow: 0 5px 18px rgba(46, 204, 113, 0.35);
}

#speak-btn {
  background: linear-gradient(135deg, #e67e22, #d35400);
  color: white;
  display: none;
  animation: pulse-orange 1.8s infinite;
  padding: 11px 18px;
  font-size: 1.0rem;
  box-shadow: 0 5px 18px rgba(230, 126, 34, 0.35);
}

@keyframes pulse-orange {
  0%, 100% { transform: scale(1); box-shadow: 0 5px 18px rgba(230, 126, 34, 0.35); }
  50% { transform: scale(1.04); box-shadow: 0 7px 22px rgba(230, 126, 34, 0.55); }
}

#speak-controls {
  display: none;
  align-items: center; /* Vertically align items */
  justify-content: center;
  gap: 8px;
  margin: 10px auto;
}

.speech-rate-indicator-inline {
  font-weight: 600;
  font-size: 0.9rem;
  color: var(--text-primary);
  opacity: 0.8;
  min-width: 35px;
  text-align: right;
}

.icon-btn {
  background: rgba(0, 0, 0, 0.05);
  border-radius: 50%;
  width: 42px;
  height: 42px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  padding: 0;
  margin: 0;
  color: var(--text-primary);
  opacity: 0.8;
  flex-shrink: 0;
  border: none;
}

.icon-btn:hover {
  background: rgba(0, 0, 0, 0.1);
  opacity: 1;
  transform: rotate(10deg) scale(1.05);
}

#word-display {
  font-size: var(--word-font-size);
  font-weight: 700;
  color: var(--accent-primary);
  text-shadow: none;
  min-height: 90px;
  display: flex;
  align-items: center;
  justify-content: center;
  letter-spacing: 1.5px;
  position: relative;
  word-break: break-all;
  /* Animation will be triggered by JS */
  opacity: 0;
  transform: scale(0.8);
}

/* NEW: Word animation classes */
#word-display.pop-in {
  animation: wordPop 0.25s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
}
#word-display.swoosh-in {
  animation: swooshIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}

@keyframes wordPop {
  0% { transform: scale(0.8) rotateX(70deg); opacity: 0; }
  60% { transform: scale(1.05) rotateX(-10deg); }
  100% { transform: scale(1) rotateX(0deg); opacity: 1; }
}

@keyframes swooshIn {
  0% { transform: translateX(-50px) scale(0.8); opacity: 0; }
  100% { transform: translateX(0) scale(1); opacity: 1; }
}

.timer-controls {
  display: flex;
  align-items: center;
  justify-content: center; /* Center horizontally */
  gap: 12px;
  grid-column: 1 / -1; /* Make it span full grid width */
  margin-top: 10px;
}

#score-display {
  font-size: 1.2rem;
  margin-top: 10px;
  font-weight: 600;
  color: var(--accent-secondary);
  line-height: 1.5;
}

/* NEW: Star Rating */
#star-rating-display {
  font-size: 2.5rem;
  color: #ffc107; /* Star yellow */
  margin-top: -10px;
}
#star-rating-display i {
  margin: 0 2px;
  transform: scale(0);
  opacity: 0;
  transition: all 0.3s ease;
}
/* Animation for stars appearing one by one */
#star-rating-display.show-stars i {
  transform: scale(1);
  opacity: 1;
}
#star-rating-display.show-stars i:nth-child(2) { transition-delay: 0.1s; }
#star-rating-display.show-stars i:nth-child(3) { transition-delay: 0.2s; }


#progress-bar {
  width: 100%;
  height: 8px;
  background: rgba(0, 0, 0, 0.05);
  border-radius: 20px;
  overflow: hidden;
  box-shadow: none;
}

#progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
  transition: width 0.2s ease;
  border-radius: 20px;
  box-shadow: none;
  position: relative;
}

/* --- Stats Grid --- */
#stats-grid {
  display: grid;
  grid-template-columns: 1fr 1fr; /* Two columns for cards */
  gap: 12px;
}

.timer-card {
  font-weight: 600;
  font-size: 1.1rem;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

/* NEW: Timer pulse animation */
@keyframes pulse-red {
  0%, 100% { transform: scale(1); color: var(--accent-danger); }
  50% { transform: scale(1.1); }
}
.timer-card.timer-low {
  animation: pulse-red 1s infinite;
  color: var(--accent-danger) !important;
}

.stat-card {
  background: rgba(0, 0, 0, 0.03);
  padding: 12px;
  border-radius: 16px;
  transition: all 0.2s ease;
  border: 1px solid var(--border-color);
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.stat-card:hover {
  transform: translateY(-3px) scale(1.02);
  background: rgba(0, 0, 0, 0.06);
  box-shadow: 0 5px 15px var(--shadow-color);
}

.stat-number {
  font-size: 3rem;
  font-weight: 700;
  background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  line-height: 1.1;
}
/* NEW: Streak Counter Style */
#streak-counter {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--accent-secondary);
}

.stat-label {
  font-size: 0.8rem;
  opacity: 0.7;
  margin-top: 4px;
}

/* --- Bottom Nav Bar --- */
#bottom-bar {
  height: auto;
  background: var(--card-bg);
  display: flex;
  justify-content: space-evenly;
  align-items: center;
  flex-wrap: nowrap;
  box-shadow: 0 8px 30px var(--shadow-color);
  transition: all 0.3s ease;
  border-radius: 22px;
  padding: 10px 8px;
  border: 1px solid var(--border-color);
  margin-top: 15px;
  margin-bottom: 10px;
  flex-shrink: 0;
}

#bottom-bar button {
  background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
  color: #ffffff;
  font-weight: 600;
  font-size: 0.95rem;
  padding: 10px 12px;
  display: flex;
  align-items: center;
  gap: 5px;
  box-shadow: 0 4px 12px hsla(from var(--accent-primary) h s l / 0.25);
  letter-spacing: 0px;
  flex-shrink: 0;
  margin: 0 3px;
  border-radius: 12px;
}

#bottom-bar button:hover {
  transform: scale(1.05);
  box-shadow: 0 5px 18px hsla(from var(--accent-primary) h s l / 0.35);
}

#bottom-bar i {
  display: inline;
  width: 18px;
  height: 18px;
}

#keyboard-hint {
  font-size: 0.8rem;
  opacity: 0.6;
  margin-top: 8px;
}

/* --- NEW: Countdown Overlay --- */
#countdown-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(8px);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20vw;
  font-weight: 700;
  color: white;
  z-index: 199;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}
#countdown-overlay.visible {
  opacity: 1;
  pointer-events: all;
}
#countdown-text {
  transform: scale(0.5);
  opacity: 0;
  text-shadow: 0 10px 30px rgba(0,0,0,0.4);
}
/* Animation for each number */
#countdown-overlay.visible #countdown-text.show {
  animation: countdown-pop 0.9s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}
@keyframes countdown-pop {
  0% { transform: scale(0.5); opacity: 0; }
  50% { transform: scale(1.1); opacity: 1; }
  100% { transform: scale(1); opacity: 1; }
}


/* --- NEW: CSS Mascot --- */
#mascot {
  width: 60px;
  height: 60px;
  position: absolute;
  bottom: 15px;
  right: 15px;
  z-index: 5;
  transition: transform 0.3s ease;
}
.mascot-body {
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, var(--accent-secondary), #f1c40f);
  border-radius: 50% 50% 40% 40%;
  position: relative;
  border: 3px solid var(--card-bg);
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  animation: mascot-idle 2s infinite ease-in-out;
}
.mascot-eye {
  width: 12px;
  height: 18px;
  background: white;
  border-radius: 50%;
  position: absolute;
  top: 18px;
  border: 2px solid #333;
  animation: mascot-blink 4s infinite;
}
.mascot-eye::after { /* Pupil */
  content: '';
  width: 6px;
  height: 6px;
  background: #333;
  border-radius: 50%;
  position: absolute;
  top: 8px;
  left: 3px;
}
.mascot-eye.left { left: 12px; }
.mascot-eye.right { right: 12px; }

.mascot-mouth {
  width: 20px;
  height: 10px;
  background: #c0392b;
  border: 2px solid #333;
  border-bottom-left-radius: 10px;
  border-bottom-right-radius: 10px;
  position: absolute;
  bottom: 12px;
  left: 50%;
  transform: translateX(-50%);
  transition: all 0.2s ease;
}

/* Mascot Animations */
@keyframes mascot-idle {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-5px); }
}
@keyframes mascot-blink {
  0%, 90% { transform: scaleY(1); }
  95% { transform: scaleY(0.1); }
  100% { transform: scaleY(1); }
}

/* Mascot States (triggered by JS) */
#mascot.cheer {
  animation: mascot-cheer-jump 0.5s ease;
}
#mascot.cheer .mascot-mouth { /* Big smile */
  width: 25px;
  height: 15px;
  border-radius: 15px;
  bottom: 10px;
}
@keyframes mascot-cheer-jump {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-15px) rotate(10deg) scale(1.1); }
}

#mascot.worried {
  animation: mascot-worried-shake 0.5s infinite;
}
#mascot.worried .mascot-mouth { /* Worried mouth */
  width: 15px;
  height: 5px;
  border-radius: 0;
  border-top: 3px solid #333;
  background: none;
  bottom: 15px;
}
@keyframes mascot-worried-shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-3px); }
  75% { transform: translateX(3px); }
}

#mascot.celebrate {
  animation: mascot-celebrate-spin 1s infinite linear;
}
#mascot.celebrate .mascot-mouth { /* Open smile */
  width: 20px;
  height: 20px;
  border-radius: 50%;
  bottom: 10px;
}
@keyframes mascot-celebrate-spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}


/* --- SETTINGS MODAL (Mostly Unchanged) --- */
#settings-backdrop, #ai-helper-backdrop {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(5px);
  z-index: 99;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}
#settings-backdrop.visible, #ai-helper-backdrop.visible {
  opacity: 1;
  pointer-events: all;
}
#settings-modal, #ai-helper-modal {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.95);
  width: 90%;
  max-width: 420px;
  background: var(--card-bg);
  border-radius: 22px;
  box-shadow: 0 15px 50px var(--shadow-color);
  border: 1px solid var(--border-color);
  z-index: 100;
  text-align: left;
  padding: 25px;
  opacity: 0;
  pointer-events: none;
  transition: all 0.3s ease;
}
#settings-backdrop.visible #settings-modal,
#ai-helper-backdrop.visible #ai-helper-modal {
  opacity: 1;
  pointer-events: all;
  transform: translate(-50%, -50%) scale(1);
}
.settings-header, .ai-helper-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 25px;
}
.settings-header h2, .ai-helper-header h2 {
  font-size: 1.7rem;
  font-weight: 700;
  margin: 0;
}
.setting-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 18px;
  padding-bottom: 18px;
  border-bottom: 1px solid var(--border-color);
}
.setting-item:last-of-type {
  border-bottom: none;
  margin-bottom: 0;
  padding-bottom: 0;
}
.setting-label {
  font-weight: 600;
  font-size: 1.0rem;
}
.setting-label small {
  display: block;
  font-weight: 400;
  opacity: 0.7;
  font-size: 0.85rem;
  margin-top: 3px;
}
.theme-selector {
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap; /* Allow wrapping */
}
.theme-option {
  display: inline-block;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  cursor: pointer;
  border: 3px solid transparent;
  transition: all 0.2s ease;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  outline: 1px solid rgba(0,0,0,0.1);
}
body.dark .theme-option {
    outline: 1px solid rgba(255,255,255,0.1);
}
.theme-option.selected {
  border-color: var(--accent-primary);
  transform: scale(1.1);
}
/* Updated theme previews */
.theme-option[data-theme="default"] { background: linear-gradient(135deg, #a6c0fe, #f68084); }
.theme-option[data-theme="ocean"] { background: linear-gradient(135deg, #48c6ef, #6f86d6); }
.theme-option[data-theme="sunset"] { background: linear-gradient(135deg, #fe8c00, #f83600); }
.theme-option[data-theme="forest"] { background: linear-gradient(135deg, #9ef5a5, #5bb964); }
.theme-option[data-theme="pink"] { background: linear-gradient(135deg, #f43b47, #453a94); }
.theme-option[data-theme="purple"] { background: linear-gradient(135deg, #9face6, #74ebd5); }
.theme-option[data-theme="skyblue"] { background: linear-gradient(135deg, #00c6ff, #0072ff); }

/* Toggle Switch Styles */
.toggle-switch {
  position: relative;
  display: inline-block;
  width: 48px;
  height: 26px;
  flex-shrink: 0;
}
.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0, 0, 0, 0.15);
  transition: .4s;
  border-radius: 26px;
}
.slider:before {
  position: absolute;
  content: "";
  height: 20px;
  width: 20px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}
input:checked + .slider {
  background-color: var(--accent-primary);
}
input:checked + .slider:before {
  transform: translateX(22px);
}

/* Range Slider Styles */
.range-slider {
  -webkit-appearance: none;
  appearance: none;
  width: 120px;
  height: 8px;
  background: rgba(0, 0, 0, 0.1);
  border-radius: 8px;
  outline: none;
  opacity: 0.7;
  transition: opacity .2s;
}
.range-slider:hover {
  opacity: 1;
}
.range-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 20px;
  height: 20px;
  background: var(--accent-primary);
  border-radius: 50%;
  cursor: pointer;
  box-shadow: 0 2px 5px hsla(from var(--accent-primary) h s l / 0.4);
}
.range-slider::-moz-range-thumb {
  width: 20px;
  height: 20px;
  background: var(--accent-primary);
  border-radius: 50%;
  cursor: pointer;
  box-shadow: 0 2px 5px hsla(from var(--accent-primary) h s l / 0.4);
}
/* In-game speak slider */
#speak-controls .range-slider {
  background: rgba(230, 126, 34, 0.2);
  width: 100px;
}
#speak-controls .range-slider::-webkit-slider-thumb {
  background: #e67e22;
  box-shadow: 0 2px 5px rgba(230, 126, 34, 0.4);
}
#speak-controls .range-slider::-moz-range-thumb {
  background: #e67e22;
  box-shadow: 0 2px 5px rgba(230, 126, 34, 0.4);
}

.setting-item .value-indicator {
  font-size: 0.9rem;
  margin-right: 10px;
  width: 45px;
  opacity: 0.8;
}
.setting-item .number-input {
  width: 110px;
  padding: 8px;
  border: 1px solid var(--border-color);
  border-radius: 10px;
  font-size: 0.95rem;
}
#reset-settings-btn {
  background: linear-gradient(135deg, var(--accent-danger), #c0392b);
  color: white;
  width: 100%;
  margin-top: 20px;
  padding: 14px;
  font-size: 1.0rem;
  box-shadow: 0 5px 18px rgba(231, 76, 60, 0.35);
}

/* --- AI Helper Modal Styles --- */
#ai-helper-content {
  margin-bottom: 20px;
}
#ai-helper-content p {
  margin-bottom: 12px;
  line-height: 1.6;
  font-size: 1.0rem;
}
#ai-buttons {
  gap: 10px;
  margin-bottom: 12px;
}
#ai-buttons button {
  font-size: 0.95rem;
  padding: 12px 15px;
  box-shadow: 0 4px 12px hsla(from var(--accent-primary) h s l / 0.25);
}
#ai-result {
  background: rgba(0, 0, 0, 0.04);
  border-radius: 16px;
  padding: 15px;
  min-height: 70px;
  line-height: 1.6;
  font-size: 0.95rem;
  border: 1px solid var(--border-color);
  white-space: pre-wrap; /* Show line breaks from API */
}
#ai-loading { /* Display block again for API calls */
  display: block;
  font-size: 0.9rem;
  margin-top: 10px;
  opacity: 0.7;
}


/* --- RESPONSIVE STYLES --- */

/* Adjustments for smaller phone screens */
@media (max-width: 370px) {
  :root { --base-font-size: 15px; }

  .nav-tab { font-size: 0.8rem; padding: 6px 10px; }
  .challenge-header h1 { font-size: 1.6rem; }
  #bottom-bar button { font-size: 0.8rem; padding: 8px 6px; gap: 3px; }
  #bottom-bar i { width: 14px; height: 14px; }
  .icon-btn { width: 36px; height: 36px; }
  #settings-modal, #ai-helper-modal { padding: 15px; }
  .settings-header h2, .ai-helper-header h2 { font-size: 1.4rem; }
  .setting-label { font-size: 0.85rem; }
  .stat-number { font-size: 2.5rem; }
  #mascot { width: 50px; height: 50px; bottom: 5px; right: 5px; }
}

/* Landscape adjustments */
@media (orientation: landscape) {
  .main-wrapper {
      flex-direction: row; /* Tabs | Content */
      align-items: stretch;
      padding: 0 8px;
      max-width: 98%;
  }
  .nav-tabs-container {
      flex-direction: column;
      justify-content: flex-start;
      width: auto;
      flex-basis: 160px; /* Wider tabs */
      flex-shrink: 0;
      margin-right: 15px;
      margin-bottom: 0;
      align-items: stretch;
      padding-top: 10px;
      padding-bottom: 10px;
  }
  .nav-tabs {
      flex-direction: column;
      align-items: stretch;
      width: 100%;
      flex-wrap: nowrap;
      padding: 8px;
      justify-content: flex-start;
      overflow-y: auto;
      overscroll-behavior: contain;
      flex-shrink: 1;
      min-height: 0;
      border-radius: 18px;
  }
   .nav-tab {
      width: 100%;
      text-align: left;
      padding: 12px 18px;
      margin: 4px 0;
      font-size: 1.0rem;
      flex-shrink: 0;
      border-radius: 14px;
  }
  .grade-section {
      padding-bottom: 10px;
  }
  .container {
      padding: 20px;
      min-height: 0;
      flex-grow: 1;
  }
  /* Ensure centering in landscape too */
  .timer-controls {
      grid-column: 1 / -1; /* Span full width */
      justify-content: center; /* Center horizontally */
      margin-left: 0;
  }

  /* Specific adjustments for landscape on short screens */
  @media (max-height: 550px) {
      :root { --base-font-size: 15px; }
      .container { padding: 12px; }
      .challenge-header h1 { font-size: 1.4rem; margin-bottom: 10px; }
      #bottom-bar { padding: 6px 4px; margin-top: 8px; margin-bottom: 5px; }
      #bottom-bar button { font-size: 0.8rem; padding: 7px 8px; gap: 3px; }
      #bottom-bar i { width: 14px; height: 14px; }
      .nav-tabs-container { flex-basis: 140px; margin-right: 10px; }
      .nav-tab { padding: 8px 12px; font-size: 0.9rem; }
      #start-btn, #speak-controls, #stats-grid, #score-display, #keyboard-hint, #progress-bar { margin-bottom: 8px; }
      .icon-btn { width: 36px; height: 36px; }
      #mascot { width: 50px; height: 50px; }
  }
}
</style>

</head>
<body class="theme-default">

<!-- Main wrapper for landscape/portrait layout -->
<div class="main-wrapper">

  <!-- Navigation Tabs -->
  <div class="nav-tabs-container">
    <div class="nav-tabs">
      <!-- Tabs now just carry data. JS handles all logic. -->
      <button class="nav-tab active" data-grade="prek">Pre-K</button>
      <button class="nav-tab" data-grade="k">Kindergarten</button>
      <button class="nav-tab" data-grade="first">First Grade</button>
      <button class="nav-tab" data-grade="second">Second Grade</button>
      <button class="nav-tab" data-grade="third">Third Grade</button>
      <button class="nav-tab" data-grade="fourth">Fourth Grade</button>
      <button class="nav-tab" data-grade="fifth">Fifth Grade</button>
      <button class="nav-tab" data-grade="more">More Grades (6+)</button>
    </div>
  </div>

  <!--
    =================================================
    === SINGLE DYNAMIC GAME SECTION (Refactored) ===
    =================================================
    This one section is now controlled entirely by JavaScript.
    No more duplicate HTML!
  -->
  <div class="grade-section" id="game-engine">
    <div class="container">

      <!-- Challenge Header (Dynamically updated) -->
      <div class="challenge-header">
        <button class="icon-btn global-settings-btn" aria-label="Open Settings">
          <i data-lucide="settings"></i>
        </button>
        <h1 id="game-title">🎯 Pre-K Challenge</h1>
      </div>

      <!-- Start State -->
      <div id="start-state-content">
        <div id="settings-section">
          <label for="timer-input">⏱️ Set Time (seconds):</label>
          <input class="timer-input" id="timer-input" type="number" min="10" value="60">
        </div>
        <p id="high-score-display">Best: 0 WPM</p>
        <button class="start-btn" id="start-btn">🚀 Start Challenge</button>
      </div>

      <!-- Game State -->
      <div id="game-state-content" style="display: none;">
        <div id="progress-bar">
          <div id="progress-fill"></div>
        </div>

        <div id="word-display">Press Start</div>

        <div id="speak-controls">
          <span class="speech-rate-indicator-inline" id="speech-rate-indicator-inline">0.9x</span>
          <input type="range" class="range-slider speech-rate-slider" id="speech-rate-slider" min="0.5" max="1.5" step="0.1">
          <button class="speak-btn" id="speak-btn">🔊 Speak</button>
        </div>

        <p class="score-display" id="score-display"></p>
        <div id="star-rating-display"></div>

        <div class="stats-grid" id="stats-grid">
          <!-- Card 1: Words Read -->
          <div class="stat-card" id="words-read-card">
            <div class="stat-number" id="words-read">0</div>
            <div class="stat-label">Letters Read</div>
          </div>

          <!-- Card 2: Timer -->
          <div class="stat-card timer-card" id="timer-card">
            <span>⏱️ Time: <span class="timer-display-value" id="timer">60</span>s</span>
          </div>

          <!-- Card 3: Streak (NEW) -->
          <div class="stat-card" id="streak-card">
             <div class="stat-number" id="streak-counter">0 🔥</div>
             <div class="stat-label">Streak</div>
          </div>

          <!-- Card 4: WPM (Shows at end) -->
          <div class="stat-card" id="wpm-card" style="display:none;">
            <div class="stat-number" id="wpm">0</div>
            <div class="stat-label">Letters/Min</div>
          </div>

          <!-- Controls (Span full grid) -->
          <div class="timer-controls">
            <button class="icon-btn ai-helper-btn" id="ai-helper-btn"><i data-lucide="brain"></i></button>
            <button class="icon-btn mute-toggle" id="mute-toggle"><i data-lucide="volume-2"></i></button>
            <button class="icon-btn theme-toggle" id="theme-toggle"><i data-lucide="moon"></i></button>
          </div>
        </div>

        <p class="keyboard-hint" id="keyboard-hint">
          ⌨️ Arrow Keys or Space • S to speak
        </p>
      </div>

      <!-- NEW: CSS Mascot -->
      <div id="mascot">
        <div class="mascot-body">
          <div class="mascot-eye left"></div>
          <div class="mascot-eye right"></div>
          <div class="mascot-mouth"></div>
        </div>
      </div>

    </div>

    <!-- Bottom Navigation Bar (Appears during game) -->
    <div class="bottom-bar" id="bottom-bar" style="display:none;">
      <button id="home-btn"><i data-lucide="home"></i> Home</button>
      <button id="restart-btn"><i data-lucide="rotate-cw"></i> Restart</button>
      <button id="back-btn"><i data-lucide="arrow-left-circle"></i> Back</button>
      <button id="next-btn"><i data-lucide="arrow-right-circle"></i> Next</button>
    </div>
  </div>
</div>

<!-- NEW: Countdown Overlay -->
<div id="countdown-overlay">
  <div id="countdown-text">3</div>
</div>

<!--
=================================================
=== MODALS (Settings & AI Helper) ===
=================================================
These are global and unchanged.
-->
<div id="settings-backdrop">
  <div id="settings-modal">
    <div class="settings-header">
      <h2>Settings</h2>
      <button class="icon-btn" id="settings-close-btn" aria-label="Close Settings">
        <i data-lucide="x"></i>
      </button>
    </div>

    <!-- Theme Selector -->
    <div class="setting-item">
      <div class="setting-label">Theme</div>
      <div class="theme-selector">
        <span class="theme-option" data-theme="default" title="Default"></span>
        <span class="theme-option" data-theme="ocean" title="Ocean"></span>
        <span class="theme-option" data-theme="sunset" title="Sunset"></span>
        <span class="theme-option" data-theme="forest" title="Forest"></span>
        <span class="theme-option" data-theme="pink" title="Pink"></span>
        <span class="theme-option" data-theme="purple" title="Purple"></span>
        <span class="theme-option" data-theme="skyblue" title="Sky Blue"></span>
      </div>
    </div>

    <div class="setting-item">
      <div class="setting-label">Dark Mode</div>
      <label class="toggle-switch">
        <input type="checkbox" id="settings-theme-toggle">
        <span class="slider"></span>
      </label>
    </div>

    <div class="setting-item">
      <div class="setting-label">Sound</div>
      <label class="toggle-switch">
        <input type="checkbox" id="settings-sound-toggle">
        <span class="slider"></span>
      </label>
    </div>

    <div class="setting-item">
      <div class="setting-label">
        Default Time <small>Challenge timer (seconds)</small>
      </div>
      <input type="number" class="number-input" id="settings-default-time" min="10" step="5">
    </div>

    <div class="setting-item">
      <div class="setting-label">
        Word Font Size <small>Size of the challenge word</small>
      </div>
      <div>
        <span class="value-indicator" id="font-size-indicator">3.5em</span>
        <input type="range" class="range-slider" id="settings-font-size" min="2" max="6" step="0.1">
      </div>
    </div>

    <div class="setting-item">
      <div class="setting-label">
        Auto-Speak Word <small>Speak new word automatically</small>
      </div>
      <label class="toggle-switch">
        <input type="checkbox" id="settings-autospeak-toggle">
        <span class="slider"></span>
      </label>
    </div>

    <div class="setting-item">
      <div class="setting-label">Voice Speed</div>
        <div>
        <span class="value-indicator" id="speech-rate-indicator">0.9x</span>
        <input type="range" class="range-slider" id="settings-speech-rate" min="0.5" max="1.5" step="0.1">
      </div>
    </div>

    <button id="reset-settings-btn">
      <i data-lucide="trash-2" style="width:18px; height:18px; margin-right: 8px;"></i>
      Reset to Defaults
    </button>
  </div>
</div>

<!-- AI HELPER MODAL -->
<div id="ai-helper-backdrop">
  <div id="ai-helper-modal">
    <div class="ai-helper-header">
      <h2><i data-lucide="brain" style="width: 24px; height: 24px; margin-right: 8px; vertical-align: bottom;"></i> AI Helper</h2>
      <button class="icon-btn" id="ai-helper-close-btn" aria-label="Close AI Helper">
        <i data-lucide="x"></i>
      </button>
    </div>
    <div id="ai-helper-content">
      <p style="display: block;">Get help with the word: <strong id="ai-word">...</strong></p>
      <p id="ai-welcome-message" style="display:none; font-style: italic; opacity: 0.8;">Hi! I'm your AI helper. Start the challenge, and I can help you define words or use them in sentences!</p>
      <div id="ai-buttons">
          <button id="ai-define-btn">Define</button>
          <button id="ai-sentence-btn">Use in Sentence</button>
      </div>
      <div id="ai-result">Tap a button above...</div>
      <!-- Loading indicator is now visible again -->
      <div id="ai-loading" style="display: none;">Generating response...</div>
    </div>
  </div>
</div>


<script>
// --- WORD LISTS ---
// (Kept here for single-file simplicity)
const WORD_LISTS = {
  prek: [..."ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz"],
  k: ["am","an","as","at","be","by","do","go","he","hi","if","in","is","it","me","my","no","of","on","or","so","to","up","us","we","a","and","are","bad","bag","bat","bed","big","bit","box","boy","bug","bun","but","buy","can","cap","car","cat","cow","cry","cub","cut","dad","day","did","dig","dip","dog","dot","dry","eat","egg","end","fan","far","fat","few","fin","fit","fix","fly","for","fog","fun","fur","get","got","gum","gun","had","has","hat","hen","her","him","his","hit","hot","how","hug","hut","ice","ink","its","jam","jar","jet","job","jog","joy","jug","key","kid","kit","lab","lad","lap","lay","led","leg","let","lid","lip","lit","log","lot","low","mad","man","map","mat","may","men","met","mix","mom","mop","mud","mug","nap","net","new","nod","not","now","nut","off","old","one","our","out","owl","own","pad","pan","pat","pay","peg","pen","pet","pig","pin","pit","pod","pop","pot","put","rag","ram","ran","rap","rat","red","rib","rid","rim","rip","rod","rot","rub","rug","run","rut","sad","sap","sat","saw","say","see","set","sew","she","shy","sin","sip","sit","six","ski","sky","sob","son","sow","sub","sue","sum","sun","tab","tag","tan","tap","tax","tea","ten","the","tie","tin","tip","toe","tom","top","toy","try","tub","tug","two","use","van","vet","war","was","wax","way","web","wed","wet","who","why","wig","win","wit","won","yes","yet","you","zip","zoo"],
  first: ["like","look","see","with","they","you","said","was","have","from","word","but","what","all","were","when","your","can","use","each","which","she","how","their","will","up","other","about","out","many","then","them","these","so","some","her","would","make","him","into","time","has","more","write","go","number","no","way","could","people","my","than","first","water","been","call","who","oil","now","find","long","down","day","get","come","made","may","part","after","again","an","any","as","ask","by","every","fly","give","giving","had","just","know","let","live","of","old","once","open","over","put","round","stop","take","thank","think","walk"],
  second: ["mat","bad","fix","ham","rig","wig","bib","sap","six","rat","sit","tag","fig","Tim","map","hat","hip","it","rap","pig","pan","in","bit","fan","kid","cab","pad","at","lad","rip","bam","big","can","rim","van","tip","dad","gap","rag","sad","fin","tin","nag","him","set","did","bed","sum","yes","hog","rut","not","jam","Ned","bud","cod","mug","fit","lab","jot","cap","pin","rug","cop","kit","gut","get","rod","met","sat","pod","cat","got","beg","wet","sub","dot","zip","puff","the","go","talk","by","friend","look","no","walk","my","because","I","book","so","could","one","woman","is","are","goes","would","once","women","a","was","says","should","two","move","as","she","or","does","both","said","what","we","for","any","four","to","have","they","there","many","fourth","do","your","their","where","been","forty","of","want","were","who","into","people","see","he","be","me","pretty","above","month","honest","toward","young","nothing","among","hour","honor","through","touch","other","again","minute","truth","learn","rough","another","against","Monday","truly","earth","tough","mother","door","Wednesday","busy","early","enough","brother","poor","February","build","buy","father","floor","eye","built","guy","water","won","heart","sure","guess","very","son","about","laugh","guest","today","always","answer","whom","guide","almost","whose","tan","nap","going","had","red","gave","good","and","give","five","veah","say","live","goe","saw","has"],
  third: ["better","bring","carry","clean","complete","cut","done","draw","drink","eight","fall","far","full","grow","hold","hot","hurt","if","keep","kind","light","long","much","myself","never","only","own","pick","seven","shall","show","six","small","start","ten","together","try","warm","around","before","best","call","cold","don't","fast","five","found","green","its","made","off","pull","read","right","sing","sleep","tell","these","those","upon","us","use","wash","wish","work","write","your","apple","baby","back","ball","bear","bird","birthday","boat","boy","bread","brother","cake","chair","chicken","children","coat","corn","cow","doll","duck","egg","eye","farm","farmer","father","feet","fire","fish","flower","game","garden","girl","goodbye","grass","ground","hand","head","hill","home","horse","house","kitty","leg","letter","man","men","milk","money","morning","mother","name","nest","night","paper","party","picture","pig","rabbit","rain","ring","robin","school","seed","sheep","shoe","sister","snow","song","squirrel","stick","street","sun","table","thing","top","toy","tree","watch","way","wind","window","wood"],
  fourth: ["accident","actual","address","appear","arrive","bicycle","breath","breathe","business","calendar","caught","center","century","certain","circle","consider","continue","describe","difficult","disappear","exercise","experience","experiment","extreme","favorite","February","forward","fruit","grammar","group","guard","guide","height","imagine","important","increase","interest","island","knowledge","length","library","material","medicine","mention","natural","neither","notice","often","opposite","ordinary","particular","peculiar","perhaps","popular","position","possess","possible","potatoes","promise","purpose","quarter","question","recent","regular","reign","remember","sentence","separate","special","straight","strange","strength","suppose","surprise","therefore","though","thought","various","weight","woman","women","although","area","argue","brain","brought","captain","chief","church","clothes","company","country","course","daughter","discover","division","during","either","eleven","energy","engine","England","Europe","evening","except","expect","explain","finally","forest","future","general","heavy","hospital","however","include","instead","journey","language","listen","little","machine","measure","middle","million","mountain","music","nation"],
  fifth: ["achieve","ancient","apparent","appreciate","approach","approve","average","awkward","bargain","barrier","borrow","boundary","brilliant","budget","burden","calculate","campaign","capacity","category","challenge","character","characteristic","chorus","citizen","column","combination","command","committee","communicate","community","compare","compete","competition","compose","concern","conclude","concrete","condition","conduct","confident","connect","conscious","consist","construct","contain","contrast","contribute","control","convince","correspond","courage","create","creature","criticize","culture","current","deceive","definite","delicious","depend","design","destroy","determine","develop","dictionary","direct","disaster","discuss","disease","distant","distribute","divide","dozen","drama","jealous","judgment","league","leisure","lightning","likely","liquid","lonely","luxury","magazine","maintain","major","manage","manual","manufacture","maximum","mischief","modern","moist","muscle","mystery","necessary","neighbor","nuisance","occupy","occur","opportunity","parliament","persuade","physical","prejudice","privilege","profession","program","pronounce","queue","recognize","recommend","relevant","restaurant","rhyme","rhythm","sacrifice","secretary","shoulder","signature","sincere","soldier","stomach","sufficient","suggest","symbol","system","temperature","thorough","twelfth","variety","vegetable","vehicle","yacht"],
  more: ["abundant","accumulate","accurate","adapt","adequate","adjacent","adjust","advantage","advocate","affect","aggravate","amateur","ambitious","ample","analyze","anxious","appeal","appropriate","approximate","arrogant","artificial","ascend","assist","attempt","attentive","authentic","benefit","bias","brief","brutal","capable","cautious","cease","chaos","chronological","clarify","classify","coarse","coherent","colossal","commence","comment","comfortable","complex","component","comprehend","conceal","concise","condemn","conflict","consecutive","consensus","consent","conspicuous","context","continuous","convenient","crucial","data","debate","debt","deceitful","declare","decline","deficient","dense","depict","desist","despise","destitute","detect","deter","diligent","diminish","disrupt","distinct","distort","diverse","dominant","drastic","drowsy","dubious","durable","eager","eccentric","edible","eerie","effect","efficient","elaborate","elegant","eligible","elite","eloquent","embark","emerge","emphasis","encounter","endeavor","endorse","endure","energetic","enhance","enigma","entice","era","essential","evade","evident","evolve","exceed","excel","exempt","exotic","expand","expert","explicit","extol","extract","extravagant","facetious","fallacy","feasible","feeble","feud","fickle","fiery","final","flagrant","flaw","flee","flimsy","fluctuate","fluent","foe","formal","frantic","frequent","frugal","futile","genuine","gigantic","glare","glum","gradual","grasp","gravity","greedy","grievance","grim","groggy","grudge","habitable","haphazard","harsh","hasty","hazardous","hesitate","hideous","hoax","hostile","identical","idle","illegible","illicit","imitate","immense","impartial","impede","implicit","imply","incessant","increment","independent","indicate","indignant","indispensable","induce","inept","inevitable","infamous","infer","infinite","infuriate","ingenious","inherent","inhibit","initial","inquiry","integral","intricate","intuitive","irate","irrelevant","jeopardize","jubilant","judicious","justify","keen","labyrinth","lack","legible","lenient","lethal","listless","literal","loathe","logical","lucid","lucrative","ludicrous","lurk","majestic","meager","mediocre","melancholy","mellow","meticulous","mimic","moderate","modest","monotonous","morbid","mundane","multitude","nimble","nonchalant","notify","numerous","nutritious","oblivious","obscure","obsolete","obstacle","ominous","opportune","ordeal","ornate","orthodox","overlap","overt","parody","passive","persist","pertinent","plausible","plea","plentiful","ponder","potent","precise","predominant","preliminary","presume","prevail","prevalent","prior","probe","proceed","prohibit","prominent","propel","profound","prolific","prospect","prudent","query","quest","radiant","random","rational","realistic","reasonable","rebel","recall","reciprocate","reckless","redundant","refuge","regime","relevant","reluctant","remote","repel","resent","resolute","respond","restrict","reveal","rigid","rigorous","rural","scarce","scatter","skeptical","scheme","scope","significant","simultaneous","sinister","slack","sleazy","slight","sluggish","solitary","sparse","spontaneous","sporadic","stable","stagnant","sterile","stern","subtle","superficial","superfluous","supplement","suppress","surpass","surplus","tangible","tedious","temperate","tentative","terminate","terrain","terse","thorough","timid","toxic","tranquil","transient","transparent","trivial","turbulent","unanimous","uncouth","unique","valid","vague","versatile","viable","vibrant","vigilant","vigorous","vivid","weary","wholesome","widespread","wily","wither","yearn","zest"]
};

// NEW: Star Rating Thresholds (WPM)
const STAR_THRESHOLDS = {
  prek: [15, 30, 45], // 1, 2, 3 stars
  k: [10, 20, 35],
  first: [20, 35, 50],
  second: [30, 50, 70],
  third: [40, 65, 85],
  fourth: [50, 80, 100],
  fifth: [60, 90, 120],
  more: [70, 100, 130]
};

// NEW: Grade Titles
const GRADE_TITLES = {
  prek: "🎯 Pre-K Challenge",
  k: "🎯 Kindergarten Challenge",
  first: "🎯 First Grade Challenge",
  second: "🎯 Second Grade Challenge",
  third: "🎯 Third Grade Challenge",
  fourth: "🎯 Fourth Grade Challenge",
  fifth: "🎯 Fifth Grade Challenge",
  more: "🎯 More Grades (6+)"
};

// --- GLOBAL STATE & SETTINGS ---
const globalSynth = window.speechSynthesis;
const SETTINGS_KEY = 'kidsySettings';
const HIGHSCORE_KEY_PREFIX = 'kidsy-highscore-';

const defaultSettings = {
  theme: 'default',
  darkMode: false,
  sound: true,
  defaultTime: 60,
  fontSize: 3.5,
  autoSpeak: false,
  speechRate: 0.9
};

let globalSettings = { ...defaultSettings };
let activeGameInstance = null;
let currentWordForAI = '';
let currentGradeForAI = ''; // Keep track of grade for AI context (though dictionary API doesn't use it)

// --- DOM Cache (Refactored) ---
// Cache all DOM elements once
const DOMElements = {
  // Navigation
  navTabs: document.querySelectorAll('.nav-tab'),

  // Game UI
  gameTitle: document.getElementById('game-title'),
  startStateContent: document.getElementById('start-state-content'),
  gameStateContent: document.getElementById('game-state-content'),
  settingsSection: document.getElementById('settings-section'),
  highScoreDisplay: document.getElementById('high-score-display'),
  startBtn: document.getElementById('start-btn'),

  // In-Game
  progressBar: document.getElementById('progress-bar'),
  progressFill: document.getElementById('progress-fill'),
  wordDisplay: document.getElementById('word-display'),
  speakControls: document.getElementById('speak-controls'),
  speechRateIndicatorInline: document.getElementById('speech-rate-indicator-inline'),
  speechRateSlider: document.getElementById('speech-rate-slider'),
  speakBtn: document.getElementById('speak-btn'),
  scoreDisplay: document.getElementById('score-display'),
  starRatingDisplay: document.getElementById('star-rating-display'),

  // Stats Grid
  statsGrid: document.getElementById('stats-grid'),
  wordsReadCard: document.getElementById('words-read-card'),
  wordsReadLabel: document.querySelector('#words-read-card .stat-label'),
  wordsRead: document.getElementById('words-read'),
  timerCard: document.getElementById('timer-card'),
  timer: document.getElementById('timer'),
  streakCard: document.getElementById('streak-card'),
  streakCounter: document.getElementById('streak-counter'),
  wpmCard: document.getElementById('wpm-card'),
  wpm: document.getElementById('wpm'),
  wpmLabel: document.querySelector('#wpm-card .stat-label'),

  // Controls
  timerInput: document.getElementById('timer-input'),
  aiHelperBtn: document.getElementById('ai-helper-btn'),
  muteToggle: document.getElementById('mute-toggle'),
  themeToggle: document.getElementById('theme-toggle'),
  keyboardHint: document.getElementById('keyboard-hint'),
  bottomBar: document.getElementById('bottom-bar'),
  homeBtn: document.getElementById('home-btn'),
  restartBtn: document.getElementById('restart-btn'),
  backBtn: document.getElementById('back-btn'),
  nextBtn: document.getElementById('next-btn'),

  // Mascot
  mascot: document.getElementById('mascot'),

  // Countdown
  countdownOverlay: document.getElementById('countdown-overlay'),
  countdownText: document.getElementById('countdown-text'),

  // Settings Modal
  settingsBackdrop: document.getElementById('settings-backdrop'),
  globalSettingsBtns: document.querySelectorAll('.global-settings-btn'),
  settingsCloseBtn: document.getElementById('settings-close-btn'),
  themeOptions: document.querySelectorAll('.theme-option'),
  settingsThemeToggle: document.getElementById('settings-theme-toggle'),
  settingsSoundToggle: document.getElementById('settings-sound-toggle'),
  settingsDefaultTime: document.getElementById('settings-default-time'),
  settingsFontSize: document.getElementById('settings-font-size'),
  fontSizeIndicator: document.getElementById('font-size-indicator'),
  settingsAutoSpeakToggle: document.getElementById('settings-autospeak-toggle'),
  settingsSpeechRate: document.getElementById('settings-speech-rate'),
  speechRateIndicator: document.getElementById('speech-rate-indicator'),
  resetSettingsBtn: document.getElementById('reset-settings-btn'),

  // AI Modal
  aiHelperBackdrop: document.getElementById('ai-helper-backdrop'),
  aiHelperCloseBtn: document.getElementById('ai-helper-close-btn'),
  aiWord: document.getElementById('ai-word'),
  aiWelcomeMessage: document.getElementById('ai-welcome-message'),
  aiButtons: document.getElementById('ai-buttons'),
  aiDefineBtn: document.getElementById('ai-define-btn'),
  aiSentenceBtn: document.getElementById('ai-sentence-btn'),
  aiResult: document.getElementById('ai-result'),
  aiLoading: document.getElementById('ai-loading') // Keep for API loading state
};


// --- GLOBAL SETTINGS FUNCTIONS ---
function saveSettings() { /* ... (keep existing) ... */ try { localStorage.setItem(SETTINGS_KEY, JSON.stringify(globalSettings)); } catch (e) { console.error("Could not save settings to localStorage", e); } }
function loadSettings() { /* ... (keep existing) ... */ let loaded = {}; try { const stored = localStorage.getItem(SETTINGS_KEY); if (stored) { loaded = JSON.parse(stored); } } catch (e) { console.error("Could not parse settings from localStorage", e); } globalSettings = { ...defaultSettings, ...loaded }; applySettings(); updateSettingsUI(); }
function applySettings() { /* ... (keep existing) ... */ document.body.className = ''; document.body.classList.add(`theme-${globalSettings.theme}`); document.body.classList.toggle('dark', globalSettings.darkMode); document.documentElement.style.setProperty('--word-font-size', `clamp(2em, ${globalSettings.fontSize * 2}vw, ${globalSettings.fontSize}em)`); DOMElements.timerInput.value = globalSettings.defaultTime; DOMElements.timer.textContent = globalSettings.defaultTime; }
function updateSettingsUI() { /* ... (keep existing) ... */ DOMElements.themeOptions.forEach(opt => { opt.classList.toggle('selected', opt.dataset.theme === globalSettings.theme); }); DOMElements.settingsThemeToggle.checked = globalSettings.darkMode; DOMElements.settingsSoundToggle.checked = globalSettings.sound; DOMElements.settingsDefaultTime.value = globalSettings.defaultTime; DOMElements.settingsFontSize.value = globalSettings.fontSize; DOMElements.fontSizeIndicator.textContent = `${globalSettings.fontSize}em`; DOMElements.settingsAutoSpeakToggle.checked = globalSettings.autoSpeak; DOMElements.settingsSpeechRate.value = globalSettings.speechRate; DOMElements.speechRateIndicator.textContent = `${globalSettings.speechRate}x`; DOMElements.speechRateSlider.value = globalSettings.speechRate; DOMElements.speechRateIndicatorInline.textContent = `${globalSettings.speechRate}x`; const isDark = globalSettings.darkMode; DOMElements.themeToggle.innerHTML = isDark ? '<i data-lucide="sun"></i>' : '<i data-lucide="moon"></i>'; const isMuted = !globalSettings.sound; DOMElements.muteToggle.innerHTML = isMuted ? '<i data-lucide="volume-x"></i>' : '<i data-lucide="volume-2"></i>'; lucide.createIcons(); }
function resetSettings() { /* ... (keep existing) ... */ if (confirm("Are you sure you want to reset all settings to their defaults?")) { globalSettings = { ...defaultSettings }; saveSettings(); applySettings(); updateSettingsUI(); DOMElements.timerInput.value = globalSettings.defaultTime; DOMElements.timer.textContent = globalSettings.defaultTime; } }

// --- GLOBAL SOUND FUNCTIONS ---
function playSound(type) { /* ... (keep existing) ... */ if (!globalSettings.sound || !Tone) return; try { if (Tone.context.state !== 'running') { Tone.start(); } let synth; switch (type) { case 'click': synth = new Tone.Synth({oscillator: { type: 'sine' }, envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.1 }}).toDestination(); synth.triggerAttackRelease('C5', '0.1'); break; case 'nav': synth = new Tone.Synth({oscillator: { type: 'triangle' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0, release: 0.1 }}).toDestination(); synth.triggerAttackRelease('E5', '0.08'); break; case 'start': synth = new Tone.Synth().toDestination(); synth.triggerAttackRelease("G4", "8n", Tone.now()); synth.triggerAttackRelease("C5", "8n", Tone.now() + 0.1); synth.triggerAttackRelease("E5", "8n", Tone.now() + 0.2); break; case 'end': synth = new Tone.Synth().toDestination(); synth.triggerAttackRelease("C5", "8n", Tone.now()); synth.triggerAttackRelease("E5", "8n", Tone.now() + 0.2); synth.triggerAttackRelease("G5", "8n", Tone.now() + 0.4); synth.triggerAttackRelease("C6", "8n", Tone.now() + 0.6); break; case 'countdown': synth = new Tone.Synth({oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.1 }}).toDestination(); synth.triggerAttackRelease('A4', '8n'); break; case 'countdownGo': synth = new Tone.Synth({oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.3, sustain: 0, release: 0.1 }}).toDestination(); synth.triggerAttackRelease('C5', '4n'); break; } } catch(e) { console.error("Tone.js sound failed:", e); } }

function speakWord(text, gradeKey) { /* ... (keep existing) ... */ if (!globalSynth || !text) return; globalSynth.cancel(); let textToSpeak = text; if (gradeKey === 'prek' && /^[A-Z]$/.test(text)) { textToSpeak = text; } const utterance = new SpeechSynthesisUtterance(textToSpeak); utterance.lang = 'en-US'; utterance.rate = globalSettings.speechRate; globalSynth.speak(utterance); }
function shuffle(arr) { /* ... (keep existing) ... */ for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]]; } return arr; }

// --- FREE DICTIONARY API Helper Function (MODIFIED) ---
async function callDictionaryApi(word, type) {
  const apiUrl = `https://api.dictionaryapi.dev/api/v2/entries/en/${word}`;

  try {
    const response = await fetch(apiUrl);
    if (!response.ok) {
        if(response.status === 404) {
             return `Sorry, I couldn't find "${word}" in the dictionary.`;
        }
      throw new Error(`Dictionary API Error: ${response.status} ${response.statusText}`);
    }
    const data = await response.json();

    // Data structure: Array of entries -> meanings -> definitions
    if (!data || !Array.isArray(data) || data.length === 0) {
      return `Sorry, no dictionary results found for "${word}".`;
    }

    // Try to find the first relevant definition or example
    let resultText = `Sorry, I couldn't get the specific info for "${word}".`;
    const entry = data[0]; // Use the first entry

    if (entry.meanings && entry.meanings.length > 0) {
      // Find the first meaning with definitions
      const meaningWithDefs = entry.meanings.find(m => m.definitions && m.definitions.length > 0);
      if (meaningWithDefs) {
        const definitionData = meaningWithDefs.definitions[0]; // Use the first definition

        if (type === 'define' && definitionData.definition) {
          resultText = definitionData.definition;
        } else if (type === 'sentence') {
          // Try finding an example in *any* definition within this meaning first
          let foundExample = null;
          for(const def of meaningWithDefs.definitions) {
              if (def.example) {
                  foundExample = def.example;
                  break; // Stop at the first example found
              }
          }
           resultText = foundExample || `No example sentence found for "${word}", but the definition is: ${definitionData.definition || 'Not available'}`;
        }
      }
    }

    return resultText;

  } catch (error) {
    console.error("Error calling Dictionary API:", error);
    return `Sorry, there was an error fetching information for "${word}". Please check your connection.`;
  }
}

function getGradeLevelString(gradeKey) { /* ... (keep existing) ... */ switch (gradeKey) { case 'prek': return 'Pre-K'; case 'k': return 'Kindergarten'; case 'first': return 'First Grade'; case 'second': return 'Second Grade'; case 'third': return 'Third Grade'; case 'fourth': return 'Fourth Grade'; case 'fifth': return 'Fifth Grade'; case 'more': return 'Sixth Grade or higher'; default: return 'the appropriate grade level'; } }

// --- MASCOT CONTROLLER ---
const Mascot = { /* ... (keep existing) ... */ element: DOMElements.mascot, setState(state) { this.element.className = state; }, cheer() { this.setState('cheer'); setTimeout(() => this.setState('idle'), 500); }, celebrate() { this.setState('celebrate'); }, worried() { this.setState('worried'); }, idle() { this.setState('idle'); } };

// --- GAME INSTANCE FACTORY (Refactored) ---
function createWordChallenge() { /* ... (keep existing setup and private functions) ... */
    let state = { gradeKey: 'prek', wordList: [], shuffledWords: [], currentWordIndex: 0, currentWord: '', currentStreak: 0, gameStarted: false, timeLeft: 0, totalTime: 0, score: 0, timerInterval: null };
    function getHighScore(gradeKey) { return parseInt(localStorage.getItem(HIGHSCORE_KEY_PREFIX + gradeKey) || 0); }
    function setHighScore(gradeKey, wpm) { localStorage.setItem(HIGHSCORE_KEY_PREFIX + gradeKey, wpm); }
    function showWord() { if (state.currentWordIndex >= state.shuffledWords.length) state.currentWordIndex = 0; if (state.currentWordIndex < 0) state.currentWordIndex = state.shuffledWords.length - 1; state.currentWord = state.shuffledWords[state.currentWordIndex]; currentWordForAI = state.currentWord; DOMElements.wordDisplay.textContent = state.currentWord; DOMElements.wordDisplay.className = Math.random() > 0.5 ? 'swoosh-in' : 'pop-in'; state.score++; updateStats(); if (globalSettings.autoSpeak && state.gameStarted) { speakWord(state.currentWord, state.gradeKey); } }
    function updateStats() { const wpmLabelText = state.gradeKey === 'prek' ? 'Letters/Min' : 'Words/Min'; const wordsReadLabelText = state.gradeKey === 'prek' ? 'Letters Read' : 'Words Read'; DOMElements.wordsRead.textContent = Math.max(0, state.score); DOMElements.streakCounter.textContent = `${state.currentStreak} 🔥`; DOMElements.wordsReadLabel.textContent = wordsReadLabelText; DOMElements.wpmLabel.textContent = wpmLabelText; const elapsed = state.totalTime - state.timeLeft; const wpm = elapsed > 0 ? Math.round((Math.max(0, state.score) / elapsed) * 60) : 0; DOMElements.wpm.textContent = wpm; }
    function updateTimer() { if (!state.gameStarted) return; state.timeLeft--; if (state.timeLeft >= 0) { DOMElements.timer.textContent = state.timeLeft; const progress = (state.timeLeft / state.totalTime) * 100; DOMElements.progressFill.style.width = progress + '%'; } if (state.timeLeft <= 10 && state.timeLeft > 0) { DOMElements.timerCard.classList.add('timer-low'); Mascot.worried(); } if (state.timeLeft <= 0) { publicMethods.endGame(); } else { updateStats(); } }
    function nextWord() { playSound('nav'); state.currentWordIndex++; state.currentStreak++; Mascot.cheer(); showWord(); }
    function prevWord() { playSound('nav'); state.currentWordIndex--; state.score -= 2; state.currentStreak = 0; Mascot.idle(); showWord(); }
    function showCountdown(callback) { let count = 3; DOMElements.countdownText.textContent = count; DOMElements.countdownOverlay.classList.add('visible'); DOMElements.countdownText.classList.add('show'); playSound('countdown'); const interval = setInterval(() => { DOMElements.countdownText.classList.remove('show'); setTimeout(() => { count--; if (count > 0) { DOMElements.countdownText.textContent = count; DOMElements.countdownText.classList.add('show'); playSound('countdown'); } else if (count === 0) { DOMElements.countdownText.textContent = "GO!"; DOMElements.countdownText.classList.add('show'); playSound('countdownGo'); } else { clearInterval(interval); DOMElements.countdownOverlay.classList.remove('visible'); DOMElements.countdownText.classList.remove('show'); callback(); } }, 150); }, 1000); }
    function showStars(wpm) { const thresholds = STAR_THRESHOLDS[state.gradeKey] || [10, 20, 30]; let stars = 0; if (wpm >= thresholds[0]) stars = 1; if (wpm >= thresholds[1]) stars = 2; if (wpm >= thresholds[2]) stars = 3; let starHTML = ''; for(let i = 0; i < 3; i++) { starHTML += `<i data-lucide="star" ${i < stars ? 'style="fill: #ffc107;"' : ''}></i>`; } DOMElements.starRatingDisplay.innerHTML = starHTML; lucide.createIcons(); setTimeout(() => DOMElements.starRatingDisplay.classList.add('show-stars'), 100); }

    const publicMethods = {
        init(gradeKey) { /* ... (keep existing) ... */ this.stopGame(); state.gradeKey = gradeKey; state.wordList = WORD_LISTS[gradeKey] || WORD_LISTS['k']; currentGradeForAI = getGradeLevelString(gradeKey); DOMElements.gameTitle.textContent = GRADE_TITLES[gradeKey] || "🎯 Kidsy Challenge"; DOMElements.timerInput.value = globalSettings.defaultTime; DOMElements.timer.textContent = globalSettings.defaultTime; DOMElements.highScoreDisplay.textContent = `Best: ${getHighScore(gradeKey)} ${gradeKey === 'prek' ? 'LPM' : 'WPM'}`; const wpmLabelText = state.gradeKey === 'prek' ? 'Letters/Min' : 'Words/Min'; const wordsReadLabelText = state.gradeKey === 'prek' ? 'Letters Read' : 'Words Read'; DOMElements.wordsReadLabel.textContent = wordsReadLabelText; DOMElements.wpmLabel.textContent = wpmLabelText; DOMElements.startStateContent.style.display = "block"; DOMElements.gameStateContent.style.display = "none"; DOMElements.bottomBar.style.display = "none"; DOMElements.wordDisplay.style.opacity = 0; Mascot.idle(); },
        startGame() { /* ... (keep existing) ... */ if (state.gameStarted) return; playSound('start'); Mascot.idle(); showCountdown(() => { state.gameStarted = true; state.score = -1; state.currentStreak = 0; state.totalTime = Math.max(10, parseInt(DOMElements.timerInput.value) || globalSettings.defaultTime); state.timeLeft = state.totalTime; DOMElements.timer.textContent = state.timeLeft; DOMElements.startStateContent.style.display = "none"; DOMElements.gameStateContent.style.display = "block"; DOMElements.speakControls.style.display = "flex"; DOMElements.speakBtn.style.display = "inline-block"; DOMElements.bottomBar.style.display = "flex"; DOMElements.statsGrid.style.display = "grid"; DOMElements.wpmCard.style.display = "none"; DOMElements.streakCard.style.display = "flex"; DOMElements.wordsReadCard.style.display = "flex"; DOMElements.timerCard.style.display = "flex"; DOMElements.keyboardHint.style.display = "block"; DOMElements.scoreDisplay.innerHTML = ""; DOMElements.starRatingDisplay.innerHTML = ""; DOMElements.starRatingDisplay.classList.remove('show-stars'); DOMElements.timerCard.classList.remove('timer-low'); state.currentWordIndex = 0; state.shuffledWords = shuffle([...state.wordList]); DOMElements.progressFill.style.width = "100%"; updateTimer(); state.timerInterval = setInterval(updateTimer, 1000); showWord(); }); },
        stopGame() { /* ... (keep existing) ... */ if (state.timerInterval) clearInterval(state.timerInterval); state.timerInterval = null; state.gameStarted = false; currentWordForAI = ''; DOMElements.startStateContent.style.display = "block"; DOMElements.gameStateContent.style.display = "none"; DOMElements.bottomBar.style.display = "none"; DOMElements.wordDisplay.textContent = "Press Start"; DOMElements.wordDisplay.className = ''; DOMElements.wordDisplay.style.opacity = 1; DOMElements.timerCard.classList.remove('timer-low'); DOMElements.highScoreDisplay.textContent = `Best: ${getHighScore(state.gradeKey)} ${state.gradeKey === 'prek' ? 'LPM' : 'WPM'}`; Mascot.idle(); },
        endGame() { /* ... (keep existing) ... */ clearInterval(state.timerInterval); state.timerInterval = null; state.gameStarted = false; currentWordForAI = ''; playSound('end'); Mascot.celebrate(); confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } }); const finalWPM = parseInt(DOMElements.wpm.textContent) || 0; const oldHighScore = getHighScore(state.gradeKey); let highScoreMessage = ''; if (finalWPM > oldHighScore) { setHighScore(state.gradeKey, finalWPM); highScoreMessage = "<br>🎉 New High Score! 🎉"; } showStars(finalWPM); DOMElements.startStateContent.style.display = "block"; DOMElements.gameStateContent.style.display = "block"; DOMElements.startBtn.style.display = "inline-block"; DOMElements.settingsSection.style.display = "block"; DOMElements.bottomBar.style.display = "none"; DOMElements.speakControls.style.display = "none"; DOMElements.speakBtn.style.display = "none"; DOMElements.keyboardHint.style.display = "none"; DOMElements.wpmCard.style.display = "flex"; DOMElements.timerCard.classList.remove('timer-low'); DOMElements.wordDisplay.textContent = "Time's Up!"; DOMElements.wordDisplay.className = 'pop-in'; DOMElements.scoreDisplay.innerHTML = `You read ${state.score} ${state.gradeKey === 'prek' ? 'letters' : 'words'}! ${highScoreMessage}`; },
        goHome() { playSound('click'); this.stopGame(); },
        restartGame() { playSound('click'); this.stopGame(); this.startGame(); },
        doNextWord() { if(state.gameStarted) nextWord(); },
        doPrevWord() { if(state.gameStarted) prevWord(); },
        doSpeakWord() { if (state.currentWord) { playSound('click'); speakWord(state.currentWord, state.gradeKey); } },
        handleKeyDown(e) { if (!state.gameStarted) { if (e.key === ' ' || e.key === 'Enter') { e.preventDefault(); playSound('click'); this.startGame(); } return; } if (e.key === 'ArrowRight' || e.key === ' ') { e.preventDefault(); nextWord(); } if (e.key === 'ArrowLeft') { e.preventDefault(); prevWord(); } if (e.key === 's' || e.key === 'S') { e.preventDefault(); this.doSpeakWord(); } },
        updateDefaultTime(time) { if (!state.gameStarted) { DOMElements.timerInput.value = time; DOMElements.timer.textContent = time; } }
    };
    return publicMethods;
}


// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {

  // Load settings from localStorage
  loadSettings();

  // Create the single game instance
  activeGameInstance = createWordChallenge();

  // --- Settings Modal Listeners ---
  function openSettings() { /* ... (keep existing) ... */ playSound('click'); updateSettingsUI(); DOMElements.settingsBackdrop.classList.add('visible'); }
  function closeSettings() { /* ... (keep existing) ... */ playSound('click'); DOMElements.settingsBackdrop.classList.remove('visible'); }
  DOMElements.globalSettingsBtns.forEach(btn => btn.addEventListener('click', openSettings));
  DOMElements.settingsCloseBtn.addEventListener('click', closeSettings);
  DOMElements.settingsBackdrop.addEventListener('click', (e) => { if (e.target === DOMElements.settingsBackdrop) closeSettings(); });

  // --- AI Helper Modal Listeners (MODIFIED FOR Dictionary API) ---
  function closeAiHelper() { /* ... (keep existing) ... */ playSound('click'); DOMElements.aiHelperBackdrop.classList.remove('visible'); }

  DOMElements.aiHelperBtn.addEventListener('click', () => {
    playSound('click');
    if (activeGameInstance && currentWordForAI) {
      DOMElements.aiWord.textContent = currentWordForAI;
      DOMElements.aiWord.parentElement.style.display = 'block';
      DOMElements.aiWelcomeMessage.style.display = 'none';
      DOMElements.aiButtons.style.display = 'flex';
      DOMElements.aiResult.textContent = 'Tap a button above...';
      DOMElements.aiLoading.style.display = 'none'; // Hide initially
    } else {
      DOMElements.aiWord.parentElement.style.display = 'none';
      DOMElements.aiWelcomeMessage.style.display = 'block';
      DOMElements.aiButtons.style.display = 'none';
      DOMElements.aiResult.textContent = '';
      DOMElements.aiLoading.style.display = 'none';
    }
    DOMElements.aiHelperBackdrop.classList.add('visible');
  });

  DOMElements.aiHelperCloseBtn.addEventListener('click', closeAiHelper);
  DOMElements.aiHelperBackdrop.addEventListener('click', (e) => { if (e.target === DOMElements.aiHelperBackdrop) closeAiHelper(); });

  // Modified function to handle Dictionary API call
  async function handleAiRequest(type) {
    if (!currentWordForAI) return;
    playSound('click');
    DOMElements.aiResult.textContent = ''; // Clear previous result
    DOMElements.aiLoading.style.display = 'block'; // Show loading

    // Call the Dictionary API
    const result = await callDictionaryApi(currentWordForAI, type);

    DOMElements.aiLoading.style.display = 'none'; // Hide loading
    DOMElements.aiResult.textContent = result; // Display result
  }
  DOMElements.aiDefineBtn.addEventListener('click', () => handleAiRequest('define'));
  DOMElements.aiSentenceBtn.addEventListener('click', () => handleAiRequest('sentence'));

  // --- Settings Control Listeners ---
    /* ... (keep existing theme, dark mode, sound, time, font size, autospeak, speed, reset listeners) ... */
    DOMElements.themeOptions.forEach(option => { option.addEventListener('click', (e) => { const newTheme = e.target.dataset.theme; if (newTheme && newTheme !== globalSettings.theme) { playSound('click'); globalSettings.theme = newTheme; saveSettings(); applySettings(); updateSettingsUI(); } }); });
    DOMElements.settingsThemeToggle.addEventListener('change', (e) => { globalSettings.darkMode = e.target.checked; saveSettings(); applySettings(); updateSettingsUI(); });
    DOMElements.settingsSoundToggle.addEventListener('change', (e) => { globalSettings.sound = e.target.checked; saveSettings(); updateSettingsUI(); if (globalSettings.sound) playSound('click'); });
    DOMElements.settingsDefaultTime.addEventListener('change', (e) => { globalSettings.defaultTime = parseInt(e.target.value) || 60; saveSettings(); if(activeGameInstance) activeGameInstance.updateDefaultTime(globalSettings.defaultTime); });
    DOMElements.settingsFontSize.addEventListener('input', (e) => { globalSettings.fontSize = parseFloat(e.target.value).toFixed(1); DOMElements.fontSizeIndicator.textContent = `${globalSettings.fontSize}em`; applySettings(); }); DOMElements.settingsFontSize.addEventListener('change', saveSettings);
    DOMElements.settingsAutoSpeakToggle.addEventListener('change', (e) => { globalSettings.autoSpeak = e.target.checked; saveSettings(); });
    DOMElements.settingsSpeechRate.addEventListener('input', (e) => { globalSettings.speechRate = parseFloat(e.target.value).toFixed(1); DOMElements.speechRateIndicator.textContent = `${globalSettings.speechRate}x`; DOMElements.speechRateSlider.value = globalSettings.speechRate; DOMElements.speechRateIndicatorInline.textContent = `${globalSettings.speechRate}x`; }); DOMElements.settingsSpeechRate.addEventListener('change', saveSettings);
    DOMElements.resetSettingsBtn.addEventListener('click', resetSettings);


  // --- DYNAMIC GAME LISTENERS ---
    /* ... (keep existing game control listeners) ... */
    DOMElements.startBtn.addEventListener('click', () => activeGameInstance.startGame());
    DOMElements.homeBtn.addEventListener('click', () => activeGameInstance.goHome());
    DOMElements.restartBtn.addEventListener('click', () => activeGameInstance.restartGame());
    DOMElements.nextBtn.addEventListener('click', () => activeGameInstance.doNextWord());
    DOMElements.backBtn.addEventListener('click', () => activeGameInstance.doPrevWord());
    DOMElements.speakBtn.addEventListener('click', () => activeGameInstance.doSpeakWord());

  // In-Game Settings
    /* ... (keep existing in-game speech rate, mute, theme listeners) ... */
    DOMElements.speechRateSlider.addEventListener('input', (e) => { globalSettings.speechRate = parseFloat(e.target.value).toFixed(1); DOMElements.speechRateIndicatorInline.textContent = `${globalSettings.speechRate}x`; updateSettingsUI(); }); DOMElements.speechRateSlider.addEventListener('change', () => { saveSettings(); activeGameInstance.doSpeakWord(); });
    DOMElements.muteToggle.addEventListener('click', () => { playSound('click'); globalSettings.sound = !globalSettings.sound; saveSettings(); updateSettingsUI(); });
    DOMElements.themeToggle.addEventListener('click', () => { playSound('click'); globalSettings.darkMode = !globalSettings.darkMode; saveSettings(); applySettings(); updateSettingsUI(); });


  // Global Keyboard Listener
    /* ... (keep existing keyboard listener) ... */
    document.addEventListener('keydown', (e) => { if (activeGameInstance) { if (e.target.tagName === 'INPUT') return; if (DOMElements.settingsBackdrop.classList.contains('visible') || DOMElements.aiHelperBackdrop.classList.contains('visible')) return; activeGameInstance.handleKeyDown(e); } });

  // --- Tab Navigation Logic ---
    /* ... (keep existing tab listener) ... */
    DOMElements.navTabs.forEach(tab => { tab.addEventListener('click', () => { playSound('click'); const targetGrade = tab.getAttribute('data-grade'); DOMElements.navTabs.forEach(t => t.classList.remove('active')); tab.classList.add('active'); if (activeGameInstance) { activeGameInstance.init(targetGrade); } }); });

  // --- Final Initialization ---
  activeGameInstance.init('prek'); // Initialize with Pre-K by default
  Mascot.idle(); // Start mascot
  updateSettingsUI(); // Initial icon render
});
</script>

</body>
</html>

